name: Test Hooks

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'openhands/storage/**hook*.py'
      - 'openhands/runtime/**hook*.py'
      - 'tests/unit/storage/**hook*.py'
      - 'tests/unit/runtime/**hook*.py'
      - 'scripts/test_hooks.py'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'openhands/storage/**hook*.py'
      - 'openhands/runtime/**hook*.py'
      - 'tests/unit/storage/**hook*.py'
      - 'tests/unit/runtime/**hook*.py'
      - 'scripts/test_hooks.py'
  workflow_dispatch:
    inputs:
      hook_type:
        description: 'Type of hooks to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - webhook
          - git-hook
      verbose:
        description: 'Enable verbose output'
        required: false
        default: false
        type: boolean
      coverage:
        description: 'Generate coverage report'
        required: false
        default: false
        type: boolean

jobs:
  test-hooks:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.12, 3.13]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install --with test
        
    - name: Run hook tests
      run: |
        # Set up environment for poetry
        source $(poetry env info --path)/bin/activate
        
        # Prepare test command arguments
        TEST_ARGS=""
        
        if [ "${{ github.event.inputs.hook_type }}" != "all" ] && [ "${{ github.event.inputs.hook_type }}" != "" ]; then
          if [ "${{ github.event.inputs.hook_type }}" = "webhook" ]; then
            TEST_ARGS="$TEST_ARGS --webhook"
          elif [ "${{ github.event.inputs.hook_type }}" = "git-hook" ]; then
            TEST_ARGS="$TEST_ARGS --git-hook"
          fi
        fi
        
        if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
          TEST_ARGS="$TEST_ARGS --verbose"
        fi
        
        if [ "${{ github.event.inputs.coverage }}" = "true" ]; then
          TEST_ARGS="$TEST_ARGS --coverage"
        fi
        
        # Run the tests
        python scripts/test_hooks.py $TEST_ARGS
        
    - name: Upload coverage reports
      if: github.event.inputs.coverage == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
      uses: codecov/codecov-action@v3
      with:
        file: ./htmlcov/index.html
        flags: hooks
        name: hooks-coverage
        
    - name: Archive coverage reports
      if: github.event.inputs.coverage == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: htmlcov/
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // Try to read test results from a file if it exists
          let testResults = "‚úÖ Hook tests completed successfully!";
          
          try {
            if (fs.existsSync('test_results.txt')) {
              testResults = fs.readFileSync('test_results.txt', 'utf8');
            }
          } catch (error) {
            console.log('Could not read test results file');
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üß™ Hook Test Results
            
            **Python Version:** ${{ matrix.python-version }}
            
            ${testResults}
            
            ---
            *This comment was automatically generated by the test-hooks workflow.*`
          });

  test-summary:
    runs-on: ubuntu-latest
    needs: test-hooks
    if: always()
    
    steps:
    - name: Test Summary
      run: |
        if [ "${{ needs.test-hooks.result }}" == "success" ]; then
          echo "‚úÖ All hook tests passed across all Python versions!"
        else
          echo "‚ùå Some hook tests failed. Check the job logs for details."
          exit 1
        fi